<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mistral Chatbot</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      /* HTMX indicator styles - show when htmx-request class is present */
      .htmx-indicator {
        opacity: 0;
        transition: opacity 200ms ease-in;
        pointer-events: none;
      }
      .htmx-request .htmx-indicator {
        opacity: 1;
      }
      .htmx-request.htmx-indicator {
        opacity: 1;
      }
      /* Disable form during request */
      .htmx-request input[type="text"],
      .htmx-request button[type="submit"] {
        opacity: 0.6;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-lg w-full max-w-4xl p-6">
      <h1 class="text-2xl font-bold mb-4 text-center">NosrednaKram Chatbot</h1>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Chat Section -->
        <div class="lg:col-span-2">
          <div
            id="chat-box"
            class="space-y-4 mb-4 max-h-96 overflow-y-auto border p-4 rounded"
          >
            {{ history_html | safe }}
          </div>
          <form
            hx-post="/chat"
            hx-target="#chat-box"
            hx-swap="beforeend"
            hx-indicator="#spinner"
            hx-on::after-request="this.querySelector('input[name=prompt]').value=''"
            id="chat-form"
            hx-include="#source-filters"
          >
            <div class="flex">
              <input
                type="text"
                name="prompt"
                placeholder="Type your message..."
                class="flex-1 border rounded-l px-4 py-2 focus:outline-none"
                id="prompt-input"
                required
              />
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r transition-colors"
                id="submit-button"
              >
                Send
              </button>
            </div>
          </form>
        </div>

        <!-- Source Filters Section -->
        <div class="lg:col-span-1" id="source-filters">
          <div class="border p-4 rounded max-h-96 overflow-y-auto">
            <h2 class="text-lg font-semibold mb-3">Filter by Sources</h2>
            <p class="text-xs text-gray-500 mb-3">
              Select sources to limit search results
            </p>
            <div class="space-y-2">
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Academic Fields"
                  class="rounded"
                />
                <span class="text-sm">Academic Fields</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="American History"
                  class="rounded"
                />
                <span class="text-sm">American History</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Astronomy"
                  class="rounded"
                />
                <span class="text-sm">Astronomy</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Biology"
                  class="rounded"
                />
                <span class="text-sm">Biology</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Chemistry Basics"
                  class="rounded"
                />
                <span class="text-sm">Chemistry Basics</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Cooking Guide"
                  class="rounded"
                />
                <span class="text-sm">Cooking Guide</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Economic Concepts"
                  class="rounded"
                />
                <span class="text-sm">Economic Concepts</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Education Concepts"
                  class="rounded"
                />
                <span class="text-sm">Education Concepts</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Exploration History"
                  class="rounded"
                />
                <span class="text-sm">Exploration History</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Finance Basics"
                  class="rounded"
                />
                <span class="text-sm">Finance Basics</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Geography"
                  class="rounded"
                />
                <span class="text-sm">Geography</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Hardware Basics"
                  class="rounded"
                />
                <span class="text-sm">Hardware Basics</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Health Tips"
                  class="rounded"
                />
                <span class="text-sm">Health Tips</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Investment Guide"
                  class="rounded"
                />
                <span class="text-sm">Investment Guide</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Italian Cuisine"
                  class="rounded"
                />
                <span class="text-sm">Italian Cuisine</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="IT Help"
                  class="rounded"
                />
                <span class="text-sm">IT Help</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Medical Basics"
                  class="rounded"
                />
                <span class="text-sm">Medical Basics</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Modern Education"
                  class="rounded"
                />
                <span class="text-sm">Modern Education</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Nutrition"
                  class="rounded"
                />
                <span class="text-sm">Nutrition</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Pasta Basics"
                  class="rounded"
                />
                <span class="text-sm">Pasta Basics</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Tech Overview"
                  class="rounded"
                />
                <span class="text-sm">Tech Overview</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Travel Guide"
                  class="rounded"
                />
                <span class="text-sm">Travel Guide</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Travel Tips"
                  class="rounded"
                />
                <span class="text-sm">Travel Tips</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="Web Standards"
                  class="rounded"
                />
                <span class="text-sm">Web Standards</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  name="sources"
                  value="World History"
                  class="rounded"
                />
                <span class="text-sm">World History</span>
              </label>
            </div>
            <button
              type="button"
              onclick="clearSourceFilters()"
              class="mt-3 text-xs text-blue-500 hover:text-blue-700"
            >
              Clear All
            </button>
          </div>
        </div>
      </div>
      <div id="spinner" class="htmx-indicator text-center mt-4">
        <svg
          class="animate-spin h-6 w-6 text-blue-500 mx-auto"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
          ></path>
        </svg>
        <p class="text-gray-500 mt-2">Thinking...</p>
      </div>
      <div id="error-box" class="hidden text-red-500 mt-4 text-center"></div>
    </div>

    <script>
      let thinkingIndicator = null;

      // Function to clear all source checkboxes
      function clearSourceFilters() {
        document.querySelectorAll('input[name="sources"]').forEach((cb) => {
          cb.checked = false;
        });
      }

      // Add thinking indicator when request starts
      document
        .getElementById("chat-form")
        .addEventListener("htmx:beforeRequest", function (evt) {
          const chatBox = document.getElementById("chat-box");

          // Add thinking indicator
          thinkingIndicator = document.createElement("div");
          thinkingIndicator.id = "thinking-indicator";
          thinkingIndicator.className =
            "p-2 bg-blue-100 rounded mb-2 flex items-center gap-2";
          thinkingIndicator.innerHTML = `
                <strong>Bot:</strong> 
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span class="text-gray-600">Thinking...</span>
            `;
          chatBox.appendChild(thinkingIndicator);

          // Scroll to bottom
          chatBox.scrollTop = chatBox.scrollHeight;
        });

      // Remove thinking indicator before server response is swapped in
      document.body.addEventListener("htmx:beforeSwap", function (evt) {
        if (evt.detail.target.id === "chat-box") {
          // Remove thinking indicator before swapping in the actual response
          if (thinkingIndicator && thinkingIndicator.parentNode) {
            thinkingIndicator.remove();
            thinkingIndicator = null;
          }
        }
      });

      // Auto-scroll chat box to bottom when new messages arrive
      document.body.addEventListener("htmx:afterSwap", function (evt) {
        if (evt.detail.target.id === "chat-box") {
          const chatBox = document.getElementById("chat-box");
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });

      // Handle errors - remove thinking indicator
      document.body.addEventListener("htmx:responseError", function (evt) {
        if (thinkingIndicator && thinkingIndicator.parentNode) {
          thinkingIndicator.remove();
          thinkingIndicator = null;
        }

        const errorBox = document.getElementById("error-box");
        errorBox.innerText = "An error occurred. Please try again.";
        errorBox.classList.remove("hidden");
        setTimeout(() => {
          errorBox.classList.add("hidden");
        }, 5000);
      });

      // Clear error box on successful requests
      document.body.addEventListener("htmx:afterRequest", function (evt) {
        if (evt.detail.xhr.status === 200) {
          document.getElementById("error-box").classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
